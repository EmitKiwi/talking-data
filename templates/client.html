<!DOCTYPE html>
<html>
<head>    
  <title>Talking Data</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<link rel="apple-touch-icon" href="/static/apple-touch-icon.png"/>
	<link rel="stylesheet" href="/static/leaflet.css" />
	<link rel="stylesheet" href="/static/style.css" />
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="/static/jquery-2.0.3.min.js"></script>
	<script src="/static/leaflet.js"></script> 
</head>
<body >
	<div id="map"></div>
	<div id="logo"></div>
	<script>
  
  var padding = 20;
  var map = new L.Map("map")
      .addLayer(new L.TileLayer("http://{s}.tiles.mapbox.com/v3/bertspaan.map-dvysiubb/{z}/{x}/{y}.png"));
      
  map.removeControl(map.zoomControl);
  map.removeControl(map.attributionControl);
  map.setView([52.3674, 4.915], 5);        

  var svg = d3.select(map.getPanes().overlayPane).append("svg"),
      g = svg.append("g").attr("class", "leaflet-zoom-hide"),
      eg = g.append("g").attr("class", "edges"),
      vg = g.append("g").attr("class", "vertices");
      
  var bounds,
      vertices = {
    "type": "FeatureCollection",
    "features": []
  };

      
  
  map.on("click", function(e) {
    var vertex = {
      type: "Feature",
      properties: {},
      geometry: {
        type: "Point",
        coordinates: [
          e.latlng.lng,
          e.latlng.lat
        ]
      }
    };
    
    vertices.features.push(vertex);
    bounds = d3.geo.bounds(vertices);
  
    update();    
  });

  map.on("viewreset", update);
  update();

  // Reposition the SVG to cover the features.
  function update() {    
    var vertex = vg.selectAll("circle")
        .data(vertices.features)
        .attr("cx", function(d) { return project(d.geometry.coordinates)[0]; })
        .attr("cy", function(d) { return project(d.geometry.coordinates)[1]; })
        .attr("r", 10);
      
    vertex.enter().append("circle")
        .attr("cx", function(d) { return project(d.geometry.coordinates)[0]; })
        .attr("cy", function(d) { return project(d.geometry.coordinates)[1]; })
        .attr("r", 10);

    var edge = eg.selectAll("line")
        .data(vertices.features, function(d, i) {
          return [i, (i + 1) % vertices.features.length];
        })
        .attr("x1", function(d, i) { return project(d.geometry.coordinates)[0]; })
        .attr("y1", function(d, i) { return project(d.geometry.coordinates)[1]; })
        .attr("x2", function(d, i) {
           return project(vertices.features[(i + 1) % vertices.features.length].geometry.coordinates)[0];
        })
        .attr("y2", function(d, i) { 
           return project(vertices.features[(i + 1) % vertices.features.length].geometry.coordinates)[1];
        })
        .attr("class", function(d, i) { return (i == vertices.features.length - 1) ? "last" : ""});
      
    edge.enter().append("line")
        .attr("x1", function(d, i) { return project(d.geometry.coordinates)[0]; })
        .attr("y1", function(d, i) { return project(d.geometry.coordinates)[1]; })
        .attr("x2", function(d, i) {
           return project(vertices.features[(i + 1) % vertices.features.length].geometry.coordinates)[0];
        })
        .attr("y2", function(d, i) { 
           return project(vertices.features[(i + 1) % vertices.features.length].geometry.coordinates)[1];
        })
        .attr("class", function(d, i) { return (i == vertices.features.length - 1) ? "last" : ""});
        
    edge.exit().remove();
            
    if (vertices.features.length) {
      // Set SVG position, translate group
      var bottomLeft = project(bounds[0]),
          topRight = project(bounds[1]);
        
      svg.attr("width", topRight[0] - bottomLeft[0] + padding * 2)
         .attr("height", bottomLeft[1] - topRight[1] + padding * 2)
         .style("margin-left", (bottomLeft[0] - padding) + "px")
         .style("margin-top", (topRight[1] - padding) + "px");
       
      g.attr("transform", "translate(" + (-bottomLeft[0] + padding) + "," + (-topRight[1] + padding) + ")");
    }
  }

  // Use Leaflet to implement a D3 geographic projection.
  function project(x) {
    var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
    return [point.x, point.y];
  }
         	
	</script>
</body>
</html>